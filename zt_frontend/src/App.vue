<template>
  <v-app>
    <v-app-bar app color="primary">
      <v-app-bar-title class="white--text">
        <v-btn icon @click="navigateToApp">
        </v-btn>
        Zero-True</v-app-bar-title>
    </v-app-bar>
    <v-main>
      <v-container v-for="codeCell in notebook.cells" >
        <component
          :is="getComponent(codeCell.cellType)"
          :cellData = codeCell
          @runCode="runCode"
          @componentValueChange="componentValueChange"
          @deleteCell="deleteCell"/>
      </v-container>
      <v-toolbar color="secondary">
        <v-btn small color="primary" @click="createCodeCell('code')">Add Code Cell</v-btn>
        <v-spacer/>
        <v-btn small color="primary" @click="createCodeCell('markdown')">Add Markdown Cell</v-btn>
        <v-spacer/>
        <v-btn small color="primary" @click="createCodeCell('text')">Add Text Cell</v-btn>
      </v-toolbar>
    </v-main>
  </v-app>
</template>


<script lang="ts">
import axios from 'axios';
import { Request, CodeRequest } from './types/request';
import { ComponentRequest } from './types/component_request';
import { DeleteRequest } from './types/delete_request';
import { CreateRequest, Celltype } from './types/create_request';
import { Response } from './types/response';
import { Notebook, CodeCell } from './types/notebook';
import CodeComponent from '@/components/CodeComponent.vue';
import MarkdownComponent from '@/components/MarkdownComponent.vue';
import EditorComponent from '@/components/EditorComponent.vue';

export default {
  components: {
    CodeComponent,
    MarkdownComponent,
    EditorComponent
  },
  data() {
    return {
      notebook: {} as Notebook,
    };
  },

  async created() {
      const response = await axios.get(import.meta.env.VITE_BACKEND_URL + 'api/notebook')
      this.notebook = response.data
  },

  methods: {
    async runCode(originId: string) {
      const cellRequests: CodeRequest[] = []
      const requestComponents: { [key: string]: any } = {};
      for (let key in this.notebook.cells){
        const cellRequest: CodeRequest = {id: key, code: this.notebook.cells[key].code}
        for (const c of this.notebook.cells[key].components){
          requestComponents[c.id] = c.value
        }
        cellRequests.push(cellRequest)
      }
      const request: Request = { originId: originId, cells: cellRequests, components: requestComponents }
      const axiosResponse = await axios.post(import.meta.env.VITE_BACKEND_URL + 'api/runcode', request)
      const response: Response = axiosResponse.data
      for (const cellResponse of response.cells){
        this.notebook.cells[cellResponse.id].components = cellResponse.components
        this.notebook.cells[cellResponse.id].output = cellResponse.output
      }
    },

    async componentValueChange(componentId: string, newValue: any){
      const componentRequest: ComponentRequest = {componentId: componentId, componentValue: newValue}
      const axiosResponse = await axios.post(import.meta.env.VITE_BACKEND_URL + 'api/component_run', componentRequest)
    },

    navigateToApp(){
      console.log('navigate')
    },

    async createCodeCell(cellType: string){
      const cellRequest: CreateRequest = {cellType: cellType as Celltype}
      const response = await axios.post(import.meta.env.VITE_BACKEND_URL + 'api/create_cell', cellRequest);
      const cell: CodeCell = response.data
      this.notebook.cells[cell.id] = cell
    },

    async deleteCell(cellId: string){
      const deleteRequest: DeleteRequest = {cellId: cellId}
      await axios.post(import.meta.env.VITE_BACKEND_URL + 'api/delete_cell', deleteRequest);
      delete this.notebook.cells[cellId]
    },

    getComponent(cellType: string){
      switch (cellType) {
        case 'code':
          return 'CodeComponent';
        case 'text':
          return 'EditorComponent';
        case 'markdown':
          return 'MarkdownComponent';
        default:
          throw new Error(`Unknown component type: ${cellType}`);
      }
    }
  }
}
</script>
<style scoped>
.editor {
  height: 300px;
  width: 100%;
  margin-bottom: 20px;
}
.run-button {
  margin-bottom: 20px;
}
</style>